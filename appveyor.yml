version: 2.0.0-alpha+{build}
branches:
  only:
  - master
os: Visual Studio 2015 Preview
configuration: Release
platform:
- x86
- x64
assembly_info:
  patch: true
  file: '**\AssemblyInfo.*'
  assembly_version: '{version}'
  assembly_file_version: '{version}'
  assembly_informational_version: '{version}'
install:
- ps: >-
    nuget restore .\NETMapnik.sln

    git clone -q https://github.com/mapbox/mapnik-vector-tile .\lib\mapnik-vector-tile

    git --git-dir=.\lib\mapnik-vector-tile\.git --work-tree=.\lib\mapnik-vector-tile checkout -q 5394eed

    (New-Object Net.WebClient).DownloadFile("http://mapnik.s3.amazonaws.com/dist/dev/mapnik-win-sdk-14.0-$env:Platform-v3.0.0-rc1-57-g2577a6c.7z", "$pwd\mapnik-win-sdk.7z")

    7z x .\mapnik-win-sdk.7z -o".\lib\$env:Platform" | FIND /V "ing  "

    git apply -p0 --directory=.\lib\$env:Platform\mapnik-sdk\includes\mapnik .\lib\image_filter_types.hpp.patch

    git apply -p0 --directory=$Env:VS140COMNTOOLS\..\..\VC\Include .\lib\mutex.patch
test_script:
- ps: vstest.console /Platform:$env:Platform /InIsolation /logger:Appveyor ".\NETMapnik.Test\bin\$env:Platform\$env:Configuration\NETMapnik.Test.dll"
on_success:
- ps: >-
    $id = "mapnik" + $(if ($env:Platform -eq "x64") {".x64"})

    $nativeplatform = $(if ($env:Platform -eq "x86") {"win32"} else {$env:Platform})

    $version = $env:APPVEYOR_BUILD_VERSION.Replace("+" + $env:APPVEYOR_BUILD_NUMBER, $env:APPVEYOR_BUILD_NUMBER.PadLeft(5,'0'))

    nuget pack .\mapnik.nuspec -NonInteractive -Properties id=$id`;platform=$env:Platform`;nativeplatform=$nativeplatform`;version=$version

    Get-ChildItem .\*.nupkg | % { Push-AppveyorArtifact $_.FullName -FileName $_.Name }